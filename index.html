<!DOCTYPE html>
<html>
  <head>
    <meta charset="UTF-8">
    <title>Photo Booth</title>
    <link rel="stylesheet" href="css/roboto.css">
    <link rel="stylesheet" href="css/font-awesome.min.css">
    <link rel="stylesheet" href="css/main.css">
  </head>
  <body onclick="takePhoto()">
    <div id="countdown"></div>
    <div id="collage"></div>
  </body>

  <script>
    import 'util';
    import fs from 'fs';
    import $ from 'jquery';
    import config from './config.json';

    // ---------------------------------------------------- //

     /*
     * Every downloaded image from your camera gets resized and stored,
     * so the files aren't giant and can be displayed properly.
     * You can defin the pixel width by "maxImageSize" in config.json
     *
     * Default maximal size is 1500, should be okay to display images in 
     * fullscreen when having a resolution not higher than 1920x1080 px
     * on your monitor.
     *
     * ----
     *
     * If you want to store all images in full size also on sd card of your camera,
     * set "keepImagesOnCamera" under gphoto2 in config.json to true. 
     *
     * Also it is important to choose the right storage on your camera, which is done
     * via the "captureTarget" property of gphoto2. E.g. if internal RAM is chosen, the image
     * will get deleted when you turn off your camera. Because it depends on your camera, I 
     * can't give you here the right choice for your setup.
     *
     * To look for the right options, run the following command in your terminal with your camera connected:
     *    gphoto2 --get-config=capturetarget
     */
    function getCmd() {
      const maxImageSize = config.maxImageSize !== undefined ? config.maxImageSize : 1500;
      const captureTarget = config.gphoto2.captureTarget !== undefined ? config.gphoto2.captureTarget: 0;
      const confKeep = config.gphoto2.keepImagesOnCamera;
      const keepImages = (confKeep !== undefined ? confKeep : true) ? '--keep ': '--no-keep';
      const confPort = config.gphoto2.port;
      const port = '--port '+((confPort !== null && confPort !== undefined && 0 !== confPort.length) ? confPort.trim() : "usb")+' ';
      const confOptParam = config.gphoto2.optionalParameter;
      const optParam = (confOptParam !== null && confOptParam !== undefined && 0 !== confOptParam.length) ? confOptParam.trim()+' ' : '';
      const cmd = "gphoto2 --set-config capturetarget="+captureTarget+" --capture-image-and-download "+keepImages+port+optParam+"--stdout "+
                  "| convert - -resize "+Math.round(maxImageSize)+" -quality 95 tmp/tmp.jpg";
      console.log('running shell command:\n'+cmd);
      return cmd;
    }

    /* Listen for pushbutton on GPIO 3 (PIN 5)
     * Activate the use of GPIOs by setting useGPIO in config.json to true.
     *
     * NOTE: To use GPIO's this application has to
     * run as root (sudo npm start)!
     *
     * For Raspberry Pi (B Rev2 / B+ / 2 / 3):
     * Connect the first port of the switchbutton to ground,
     * second to GPIO 3 (PIN 5) and to an resistor of about 10k-100kΩ,
     * the other end of the resistor to 3.3V (e.g. PIN 1)
     *
     * _______RASPBERRY PI_______
     *                          |
     *          |----3.3V---●o  |
     * ~50kΩ →  ▯           oo  |
     *          |----GPIO3--●o  |
     *      [-\             oo  |
     *         \------GND---●o  |
     *                      oo  |
     *                      oo  |
     *                      oo  |
     *                      oo  |
     *                      oo  |
     *                      oo  |
     *                      oo  |
     *                      oo  |
     *                          |
     *                          |
     */
    if (config.useGPIO !== undefined ? config.useGPIO : true) {
      console.log('GPIO usage activated');
      var gpio = require('rpi-gpio');
      gpio.setMode(gpio.MODE_BCM);
      gpio.setup(3, gpio.DIR_IN, gpio.EDGE_BOTH);
      gpio.on('change', function(channel, value) {
        if (channel == 3 && !value) takePhoto();
        // NOTE: takePhoto() is secure to don't run twice 
        // at the same time, make sure this is also so for
        // your code.
      });
    }

    function getErrorMessage() {
      var errorMessage = config.errorMessage !== undefined ? config.errorMessage : "Sorry, please try again ...";
      return '<span class="fadein">'+ errorMessage+'</span>';
    }

    // ---------------------------------------------------- //

    var isTakingPhoto = false;
    function takePhoto() {
      // prevent two tasks at the same time!
      if (isTakingPhoto) return;

      isTakingPhoto = true;
      var duration = 5;
      
      var countdown = $("#countdown");
      countdown.fadeIn(250);
      countdown.html('<span class="fadeout">'+duration+'</span>');

      var counter = setInterval(function () {
          duration--;

          if (duration > 0) {
            countdown.html('<span class="fadeout">'+duration+'</span>');
          }

          if (duration == 1) {
            takePhotoSaveShowAndHide(countdown);
          }

          if (duration == 0 && !countdown.html().includes(getErrorMessage())) {
            countdown.html('');
          }

          if (duration == -2) {
            if (!countdown.html().includes(getErrorMessage())) {
              countdown.html('<div class="loading"><i class="fa fa-circle-o-notch fa-spin fa-3x fa-fw"></i></div>');
            }
            clearInterval(counter);
          }
        }, 1000);
    }

    // ---------------------------------------------------- //

    function takePhotoSaveShowAndHide(countdown){
      var exec = require('child_process').exec;

      if (!fs.existsSync('./tmp')) fs.mkdirSync('./tmp');
      
      var child = exec(getCmd(), function (error, stdout, stderr) {
        
         // if error occured
        if (error !== null || error === undefined) {
          countdown.html(getErrorMessage());
          console.log('exec error: ' + error);

          // show error message for 3 seconds then hide
          hideCountdown(3);

        } else {

          var dir = process.env.HOME+'/booth-images';
          if (!fs.existsSync(dir)) fs.mkdirSync(dir);

          // move tmp.jpg in main folder
          var filepath = dir+'/'+'img_'+getTimestamp(new Date())+'.jpg';
          fs.rename('tmp/tmp.jpg', filepath);

          var preview = '<div id=\'preview\' style=\'background-image: url(\"'+filepath+'\");\'></div>';

          countdown.html(preview);

          // add image to collage
          var img = $('<img>');
          img.attr('src', filepath);
          $("#collage").prepend(img);

          scaleCollageImages();

          // show picture for 5 seconds then hide
          hideCountdown(5);
        }
      });
    }

    // ---------------------------------------------------- //

    function hideCountdown(delay) {
      var waiter = setInterval(function() {
        $("#countdown").addClass("fadeout");
        var wait = setInterval(function() {
          $("#countdown").hide();
          $("#countdown").removeClass("fadeout");
          $("#countdown").html('');
          isTakingPhoto = false;
          clearInterval(wait);
        }, 500);
        clearInterval(waiter);
      }, delay*1000);
    }

    // ---------------------------------------------------- //

    $( window ).resize(function() {
      scaleCollageImages();
    });

    // ---------------------------------------------------- //

    function scaleCollageImages() {
      var collageWidth = $("#collage").width();
      var imgPerRow = Math.round(collageWidth/300);              
      $("#collage > img").outerWidth(collageWidth/imgPerRow);

      while( $("#collage").children().length > 4*Math.pow(imgPerRow, 2)) {
         $("#collage").children().last().remove();
      }
    }

    // ---------------------------------------------------- //

    function getTimestamp(now) {
      return now.getFullYear()+'-'+(now.getMonth()+1)+'-'+now.getDate()+'_'+now.getHours()+'-'+now.getMinutes()+'-'+now.getSeconds();
    }

    function getDate(now) {
      return now.getFullYear()+'-'+(now.getMonth()+1)+'-'+now.getDate();
    }

  </script>

</html>


