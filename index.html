<!DOCTYPE html>
<html>
  <head>
    <meta charset="UTF-8">
    <title>Photo Booth</title>
    <link rel="stylesheet" href="css/roboto.css">
    <link rel="stylesheet" href="css/font-awesome.min.css">
    <link rel="stylesheet" href="css/main.css">
  </head>
  <body onclick="takePhoto()">
    <div id="countdown"></div>
    <div id="collage"></div>
    <!--<div id="wrapper">

      <div id="top">
      </div>
      <div id="middle">
        <div id="imageWrapper"></div>
      </div>
      <div id="bottom">
        <button>Tap to start</button>
      </div>

    </div>-->
  </body>

  <script>
    import 'util';
    import fs from 'fs';
    import $ from 'jquery';
    import gpio from 'rpi-gpio';

    /*
     * Max Image Width/Height
     *
     * Every downloaded image from your camera gets resized and stored,
     * so the files aren't giant and can be displayed properly.
     *
     * Define the maximum width or height of the images here.
     */
    const maxImageSize = 1500;  // px, Size of saved images on the computer

    /*
     * Set the capture target on your camera
     *
     * You need to say gphoto2 where to save the photos on the camera. If you want
     * to let them in full quality at your camera's sd card, you have to choose the
     * right value here. Because it depends on your camera, I can't give you here
     * the right choice for your setup.
     *
     * To look for the right options, run the following command in your terminal:
     * gphoto2 --get-config=capturetarget
     */
    const captureTarget = 1;    // default: 1


    const errorMessage = '<span class="fadein">Sorry, please try again ...</span>';
    var isTakingPhoto = false;

    // ---------------------------------------------------- //

    /* Listen for pushbutton on GPIO 3 (PIN 5)
     *
     * NOTE: To use GPIO's this application has to
     * run as root (sudo npm start)!
     *
     * For Raspberry Pi (B Rev2 / B+ / 2 / 3):
     * Connect the first port of the switchbutton to ground,
     * second to GPIO 3 (PIN 5) and to an resistor of about 10k-100kΩ,
     * the other end of the resistor to 3.3V (e.g. PIN 1)
     *
     * _______RASPBERRY PI_______
     *                          |
     *          |----3.3V---●o  |
     * ~50kΩ →  ▯           oo  |
     *          |----GPIO3--●o  |
     *      [-\             oo  |
     *         \------GND---●o  |
     *                      oo  |
     *                      oo  |
     *                      oo  |
     *                      oo  |
     *                      oo  |
     *                      oo  |
     *                      oo  |
     *                      oo  |
     *                          |
     *                          |
     */
    gpio.setMode(gpio.MODE_BCM);
    gpio.setup(3, gpio.DIR_IN, gpio.EDGE_BOTH);
    gpio.on('change', function(channel, value) {
      if (channel == 3 && !value) takePhoto();
      // NOTE: takePhoto() is secure to don't run twice 
      // at the same time, make sure this is also so for
      // your code.
    });

    // ---------------------------------------------------- //

    function takePhoto() {
      // prevent two tasks at the same time!
      if (isTakingPhoto) return;

      isTakingPhoto = true;
      var duration = 5;
      
      var countdown = $("#countdown");
      countdown.fadeIn(250);
      countdown.html('<span class="fadeout">'+duration+'</span>');

      var counter = setInterval(function () {
          duration--;

          if (duration > 0) {
            countdown.html('<span class="fadeout">'+duration+'</span>');
          }

          if (duration == 1) {
            takePhotoSaveShowAndHide(countdown);
          }

          if (duration == 0 && !countdown.html().includes(errorMessage)) {
            countdown.html('');
          }

          if (duration == -2) {
            if (!countdown.html().includes(errorMessage)) {
              countdown.html('<div class="loading"><i class="fa fa-circle-o-notch fa-spin fa-3x fa-fw"></i></div>');
            }
            clearInterval(counter);
          }
        }, 1000);
    }

    // ---------------------------------------------------- //

    function takePhotoSaveShowAndHide(countdown){
      var exec = require('child_process').exec;

      var tmpimage= 'tmp/tmp.jpg';
      if (!fs.existsSync('./tmp')) fs.mkdirSync('./tmp');

      const cmd = "gphoto2 --set-config capturetarget="+captureTarget+" --capture-image-and-download --keep --stdout | convert - -resize "+Math.round(maxImageSize)+" -quality 95 "+tmpimage;
      
      var child = exec(cmd, function (error, stdout, stderr) {
        
         // if error occured
        if (error !== null || error === undefined) {
          countdown.html(errorMessage);
          console.log('exec error: ' + error);

          // show error message for 3 seconds then hide
          hideCountdown(3);

        } else {

          var dir = process.env.HOME+'/booth-images';
          if (!fs.existsSync(dir)) fs.mkdirSync(dir);

          // move tmp.jpg in main folder
          var filepath = dir+'/'+'img_'+getTimestamp(new Date())+'.jpg';
          fs.rename(tmpimage, filepath);

          var preview = '<div id=\'preview\' style=\'background-image: url(\"'+filepath+'\");\'></div>';

          countdown.html(preview);

          // add image to collage
          var img = $('<img>');
          img.attr('src', filepath);
          $("#collage").prepend(img);

          scaleCollageImages();

          // show picture for 5 seconds then hide
          hideCountdown(5);
        }
      });
    }

    // ---------------------------------------------------- //

    function hideCountdown(delay) {
      var waiter = setInterval(function() {
        $("#countdown").addClass("fadeout");
        var wait = setInterval(function() {
          $("#countdown").hide();
          $("#countdown").removeClass("fadeout");
          $("#countdown").html('');
          isTakingPhoto = false;
          clearInterval(wait);
        }, 500);
        clearInterval(waiter);
      }, delay*1000);
    }

    // ---------------------------------------------------- //

    $( window ).resize(function() {
      scaleCollageImages();
    });

    // ---------------------------------------------------- //

    function scaleCollageImages() {
      var collageWidth = $("#collage").width();
      var imgPerRow = Math.round(collageWidth/300);              
      $("#collage > img").outerWidth(collageWidth/imgPerRow);
    }

    // ---------------------------------------------------- //

    function getTimestamp(now) {
      return now.getFullYear()+'-'+(now.getMonth()+1)+'-'+now.getDate()+'_'+now.getHours()+'-'+now.getMinutes()+'-'+now.getSeconds();
    }

    function getDate(now) {
      return now.getFullYear()+'-'+(now.getMonth()+1)+'-'+now.getDate();
    }

  </script>

</html>


