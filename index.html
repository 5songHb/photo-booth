<!DOCTYPE html>
<html>
  <head>
    <meta charset="UTF-8">
    <title>Photo Booth</title>
    <link rel="stylesheet" href="css/roboto.css">
    <link rel="stylesheet" href="css/font-awesome.min.css">
    <link rel="stylesheet" href="css/main.css">
  </head>
  <body onclick="takePhoto()">
    <div id="countdown"></div>
    <div id="collage"></div>
    <!--<div id="wrapper">

      <div id="top">
      </div>
      <div id="middle">
        <div id="imageWrapper"></div>
      </div>
      <div id="bottom">
        <button>Tap to start</button>
      </div>

    </div>-->
  </body>

  <script>
    import $ from 'jquery';
    import PythonShell from 'python-shell';
    import gpio from 'rpi-gpio';

    /* Listen for pushbutton on GPIO 3 (PIN 5)
     *
     * For Raspberry Pi (B Rev2 / B+ / 2 / 3):
     * Connect the first port of the switchbutton to ground,
     * second to GPIO 3 (PIN 5) and to an resistor of about 10k-100kΩ,
     * the other end of the resistor to 3.3V (e.g. PIN 1)
     *
     *          |-----3.3V--●o
     * ~50kΩ →  ▯           oo
     *          |----GPIO3--●o
     *      [-\             oo
     *         \------GND---●o
     *                      oo
     *                      oo
     *                      oo
     *                      oo
     *                      oo
     *                      oo
     *                      oo
     *                      oo
     */
    gpio.setMode(gpio.MODE_BCM);
    gpio.setup(3, gpio.DIR_IN, gpio.EDGE_BOTH);
    gpio.on('change', function(channel, value) {
        console.log('Channel ' + channel + ' value is now ' + value);
    });

    $("#countdown").hide();

    var isTakingPhoto = false;
    function takePhoto() {
      // prevent two tasks at the same time!
      if (isTakingPhoto) return;

      isTakingPhoto = true;
      var duration = 5;
      var errorMessage = '<span class="fadein">Sorry, please try again ...</span>';
      var countdown = $("#countdown");
      countdown.fadeIn(250);
      countdown.html('<span class="fadeout">'+duration+'</span>');

      var counter = setInterval(function () {
          duration--;

          if (duration > 0) {
            countdown.html('<span class="fadeout">'+duration+'</span>');
          }

          if (duration == 1) {
            // make photo and display it!
           
            var pyshell = new PythonShell('./python/capture.py');

            pyshell.on('message', function (message) {
              // received a message sent from the Python script (a simple "print" statement)
              console.log("Image url: "+message);
              //countdown.html('');
              //countdown.css('background-image', 'url(' + message + ')');
              var preview = '<div id=\'preview\' style=\'background-image: url(\"'+message+'\");\'></div>';

              countdown.html(preview);

              // add image to collage
              var img = $('<img>');
              img.attr('src', message);
              $("#collage").prepend(img);

              scaleCollageImages();

            });

            // end the input stream and allow the process to exit
            pyshell.end(function (err) {

              if (!err) {
                // show picture for 5 seconds then hide
                hideCountdown(5);
              } else {
                // show error message for 5 seconds then hide
                countdown.html(errorMessage);
                hideCountdown(3);
                throw err;
              }
            });
          }

          if (duration == 0 && !countdown.html().includes(errorMessage)) {
            countdown.html('');
          }

          if (duration == -2) {
            if (!countdown.html().includes(errorMessage)) {
              countdown.html('<div class="loading"><i class="fa fa-circle-o-notch fa-spin fa-3x fa-fw"></i></div>');
            }
            clearInterval(counter);
          }
        }, 1000);
    }

    function hideCountdown(delay) {
      var waiter = setInterval(function() {
        $("#countdown").addClass("fadeout");
        var wait = setInterval(function() {
          $("#countdown").hide();
          $("#countdown").removeClass("fadeout");
          $("#countdown").html('');
          isTakingPhoto = false;
          clearInterval(wait);
        }, 500);
        clearInterval(waiter);
      }, delay*1000);
    }

    $( window ).resize(function() {
      scaleCollageImages();
    });

    function scaleCollageImages() {
      var collageWidth = $("#collage").width();
      var imgPerRow = Math.round(collageWidth/300);              
      $("#collage > img").outerWidth(collageWidth/imgPerRow);
    }


  </script>

</html>


